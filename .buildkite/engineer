#!/usr/bin/env bash

set -ex

node -v
npm -v

git clone https://github.com/timsuchanek/last-git-changes.git
cd last-git-changes
npm install
npm run build
cd ..
node last-git-changes/bin.js --exclude='docs,examples,scripts,README.md,LICENSE,CONTRIBUTING.md,.github,.prettierrc.yml' 
export CHANGED_COUNT=$(node last-git-changes/bin.js --exclude='docs,examples,scripts,README.md,LICENSE,CONTRIBUTING.md,.github,.prettierrc.yml' | wc -l)

echo $CHANGED_COUNT

if [ $CHANGED_COUNT -gt 0 ]; then
  echo "Something changed, TODO"
else
  echo "Nothing changed, this run will be skipped now."
fi


if [[ "$OSTYPE" == "linux-gnu" ]]; then
    OS=linux-amzn
elif [[ "$OSTYPE" == "darwin"* ]]; then
    OS=darwin
else
    echo "Unhandled OS: '$OSTYPE'"
    exit 1
fi

# Check if the system has engineer installed, if not, use a local copy.
if ! type "engineer" &> /dev/null; then
    # Setup Prisma engine build & test tool (engineer).
    set -e
    curl --fail -sSL "https://prisma-engineer.s3-eu-west-1.amazonaws.com/1.59/latest/$OS/engineer.gz" --output engineer.gz
    gzip -d engineer.gz
    chmod +x engineer

    # Execute passed command and clean up
    ./engineer "$@"
    rm -rf ./engineer
else
    # Already installed on the system
    set -e
    engineer "$@"
fi
