name: Driver Adapter Smoke Tests
on:
  push:
    branches:
      - main
  pull_request:
    paths-ignore:
      - '.buildkite/**'
      - '*.md'
      - 'LICENSE'
      - 'CODEOWNERS'
      - 'renovate.json'

jobs:
  driver-adapter-smoke-tests:
    name: Smoke

    strategy:
      fail-fast: false
      #matrix:
      #  adapter: [neon, neon-http, planetscale, pg]
  
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      JS_NEON_DATABASE_URL: postgres://USER:PASSWORD@DATABASE-pooler.eu-central-1.aws.neon.tech/neondb?pgbouncer=true&connect_timeout=10"# ${{ secrets.JS_NEON_DATABASE_URL }}
      JS_PLANETSCALE_DATABASE_URL: mysql://USER:PASSWORD@aws.connect.psdb.cloud/DATABASE?sslaccept=strict # ${{ secrets.JS_PLANETSCALE_DATABASE_URL }}
      JS_PG_DATABASE_URL: postgres://postgres:postgres@localhost:5432/test # ${{ secrets.JS_PG_DATABASE_URL }}

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
      - name: Compile Query Engine
        run: cargo build -p query-engine-node-api

      - uses: pnpm/action-setup@v2.4.0
        with:
          version: 8
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'pnpm'

      - name: Install Dependencies (Driver Adapters)
        run: pnpm install
        working-directory: ./query-engine/driver-adapters/js
      - name: Build Driver Adapters
        run: pnpm build
        working-directory: ./query-engine/driver-adapters/js

      - name: Install Dependencies (Smoke Tests)
        run: pnpm install
        working-directory: ./query-engine/driver-adapters/js/smoke-test-js
      
      - run: pnpm prisma:pg
        working-directory: ./query-engine/driver-adapters/js/smoke-test-js
      - run: pnpm pg
        working-directory: ./query-engine/driver-adapters/js/smoke-test-js
