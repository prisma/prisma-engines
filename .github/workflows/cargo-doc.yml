name: Generate cargo docs
on:
  workflow_dispatch:
    inputs: # null
  push:
    branches:
      - main
      - fix-cargo-doc-action
      
jobs:
  generate-cargo-docs:
    name: "Generate cargo docs for the workspace"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true

    steps:
      - uses: actions/checkout@v3

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}

      # We explicitly exclude dependencies whose docs are excessively large.
      # 61MB for typenum alone alone as of this writing.
      - name: Generate docs
        run: |
          cargo doc \
            --workspace \
            --exclude typenum \
            --exclude futures \
            --exclude openssl_sys \
            --exclude libc \
            --exclude object \
            --exclude digest \
            --exclude tiberius

      - name: Move docs to gh-pages branch
        run: |
          mkdir -p /tmp/cargo-doc-output
          mv target/doc /tmp/cargo-doc-output/doc

      - uses: actions/checkout@v3
        with:
          ref: gh-pages

      - name: Replace old docs with new docs
        run: |
          rm -rf ./doc
          mv /tmp/cargo-doc-output/doc doc

      - name: Commit and push new docs
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: cargo docs for ${{ env.GITHUB_SHA }}
          branch: gh-pages
          commit_user_name: prisma-bot
          commit_user_email: prismabots@gmail.com
          commit_author: prisma-bot <prismabots@gmail.com>

